<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Planazoo v9 (fases + login)</title>
  <meta name="theme-color" content="#fff" id="meta-theme">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/favicon.ico">
  <style>
:root{--b:#6C4CF5;--b2:#7D5CF8;--bg:#faf9f7;--card:#fff;--line:#e6e6ea;--fg:#101423;--muted:#455065;--chip:#fff;--tab:#fff;--accent:#4a56ff}
:root.dark{--bg:#0b0e14;--card:#121625;--line:#2a3247;--fg:#e8ecf7;--muted:#c7cfdb;--chip:#0f1423;--tab:#0f1423;--accent:#a8b6ff}
*{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg)}
.appbar{position:sticky;top:0;display:flex;gap:10px;align-items:center;padding:12px 16px;border-bottom:1px solid var(--line);background:color-mix(in oklab,var(--bg) 92%,transparent);backdrop-filter:blur(8px)}
.appbar .t{font-weight:800}.appbar .sp{flex:1}.ib{border:1px solid var(--line);background:var(--chip);border-radius:12px;padding:8px 10px;cursor:pointer}
.appbar .avatarbtn{display:flex;align-items:center;gap:8px;border-radius:999px;padding:6px 10px}
.avatar{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;background:color-mix(in oklab,var(--b) 25%, var(--chip));color:#fff;font-weight:800}
.menu{position:absolute;top:58px;right:16px;background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.2);display:none;min-width:220px;z-index:20}
.menu.open{display:block}
.menu a{display:flex;align-items:center;gap:8px;padding:10px 12px;color:inherit;text-decoration:none;border-bottom:1px solid var(--line)}
.menu a:last-child{border-bottom:none}
.content{padding:16px;max-width:1100px;margin:0 auto;padding-bottom:88px}
.card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:16px}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}.col{display:flex;flex-direction:column;gap:8px}
.input,select,textarea{padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:var(--chip);color:var(--fg);width:100%}
.grid{display:grid;gap:12px}.cards{grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
.btn{padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:var(--chip);cursor:pointer;font-weight:600}
.p{background:linear-gradient(135deg,var(--b),var(--b2));border:none;color:#fff}.s{padding:8px 10px;font-size:14px}
.pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:var(--chip);font-size:12px;color:var(--muted)}
.opt{border:1px solid var(--line);border-radius:14px;padding:12px;background:var(--chip)}
.view{display:none}.view.on{display:block}
.tabbar{position:fixed;left:0;right:0;bottom:0;border-top:1px solid var(--line);background:var(--tab);display:grid;grid-template-columns:repeat(5,1fr);gap:6px;padding:6px}
.tab{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 6px;border-radius:12px;color:var(--muted);cursor:pointer}
.tab.on{color:var(--fg);background:color-mix(in oklab,var(--b) 12%,transparent)}.star{font-size:22px;filter:grayscale(1) opacity(.7);cursor:pointer}.star.on{filter:none}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:40}
.sheet{background:var(--card);border:1px solid var(--line);border-radius:18px;max-width:640px;width:100%;padding:16px}
svg.logo{width:34px;height:34px;border-radius:10px}svg.lg{width:64px;height:64px;border-radius:16px}
a.link{color:var(--accent);text-decoration:underline;word-break:break-all}
.steps{display:flex;gap:8px;align-items:center;margin:8px 0}
.step{display:flex;align-items:center;gap:8px}
.dot{width:22px;height:22px;border-radius:50%;border:2px solid var(--line);display:grid;place-items:center;font-weight:800;color:var(--muted);background:var(--chip)}
.step.on .dot{border-color:var(--b);background:var(--b);color:#fff}
.step.done .dot{border-color:#3dd68c;background:#3dd68c;color:#0a121a}
.substep{display:none}.substep.on{display:block}
.chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:var(--chip)}
@media (max-width: 520px){
  .content{max-width:520px;padding:12px;padding-bottom:96px}
  .row{flex-direction:column;align-items:stretch}
  .grid.cards{grid-template-columns:1fr}
  .steps{flex-wrap:wrap}
  .tabbar{gap:4px;padding:6px}
  .appbar{gap:8px;padding:10px 12px}
  #crear .card{overflow:hidden}
}
:root.dark .btn{background:#121a2a;border-color:#3b4763;color:#e8ecf7}
:root.dark .btn.p{background:linear-gradient(135deg,var(--b),var(--b2));border:none;color:#fff}
:root.dark .pill{background:#0f1423;border-color:#3b4763;color:#cfe2ff}
:root.dark .opt{background:#0f1423;border-color:#3b4763}
:root.dark .input, :root.dark select, :root.dark textarea{background:#0f1423;border-color:#3b4763;color:#e8ecf7}
.btn:focus{outline:2px solid color-mix(in oklab,var(--b) 40%, transparent); outline-offset:2px}
#rst{display:flex;gap:8px;align-items:center;flex-wrap:nowrap}
.star{font-size:26px;line-height:1;display:inline-block;color:#a0a7b4}
.star.on{color:#FFC400;filter:none}
.btngrp{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
.rating, .rating-stars, #ratingStars, #rst, .stars { display:flex; gap:8px; align-items:center; flex-wrap:nowrap }
.star, .rating .star, .stars .star { font-size:26px; line-height:1; display:inline-block; color:#a0a7b4; cursor:pointer }
.star.on, .star.active { color:#FFC400 }
.btngrp { display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center }
.card .btngrp .btn { white-space:nowrap }
.vote-actions, .actions, #voteActions { display:flex; flex-wrap:wrap; gap:8px; align-items:center }
.vote-actions .btn, .actions .btn { min-width:0; flex:0 0 auto }
.vote-actions .link, .actions .link { word-break:break-word; overflow-wrap:anywhere }
.modal { position:fixed; inset:0; overflow:auto }
.modal .sheet { max-height:90vh; overflow:auto; -webkit-overflow-scrolling:touch; overscroll-behavior:contain }
body.modal-open { overflow:hidden }
.container, .sheet, .page { overflow-x:hidden }
  </style>
</head>
<body>
<div class="app">
  <!-- Sprite SVG (tu logo actual) -->
  <svg style="position:absolute;width:0;height:0">
    <symbol id="m" viewBox="0 0 512 512">
      <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#6C4CF5"/><stop offset="1" stop-color="#7D5CF8"/></linearGradient></defs>
      <rect width="512" height="512" rx="110" fill="url(#g)"/>
      <g transform="translate(86,86)">
        <path d="M246 84c9-10 14-21 14-31 0-17-19-26-37-20-16 6-31 12-51 12s-35-6-51-12c-18-6-37 3-37 20 0 10 5 21 14 31-26 20-42 50-42 85 0 72 58 130 130 130s130-58 130-130c0-35-16-65-42-85z" fill="#2f2731"/>
        <circle cx="36" cy="160" r="38" fill="#F6D2A0"/><circle cx="320" cy="160" r="38" fill="#F6D2A0"/>
        <path d="M96 156c0 50 42 90 96 90s96-40 96-90c0-42-43-78-96-78s-96 36-96 78z" fill="#F6D2A0"/>
        <circle cx="176" cy="168" r="12" fill="#0f0c10"/><circle cx="208" cy="168" r="12" fill="#0f0c10"/><circle cx="192" cy="188" r="6" fill="#2f2731"/>
        <path d="M164 214c18 12 38 12 56 0" stroke="#2f2731" stroke-width="8" fill="none" stroke-linecap="round"/>
      </g>
    </symbol>
  </svg>

  <div class="appbar">
    <svg class="logo" viewBox="0 0 512 512"><use href="#m"/></svg><div class="t">Planazoo</div>
    <div class="sp"></div>
    <button id="th" class="ib" title="Tema">üåì</button>
    <button class="ib" onclick="openPrefs()" title="Preferencias">‚öôÔ∏è</button>
    <button id="abtn" class="ib avatarbtn" title="Cuenta">
      <div id="aico" class="avatar">?</div><small id="aname" class="pill">Invitado</small>
    </button>
    <div id="amenu" class="menu">
      <a href="#" onclick="openLogin();return false;">üë§ Iniciar sesi√≥n</a>
      <a href="#" onclick='tab("stats");closeMenu();return false;'>üìä Estad√≠sticas</a>
      <a href="#" onclick="logout();return false;">‚Ü©Ô∏è Cerrar sesi√≥n</a>
    </div>
  </div>

  <div class="content">
    <section id="home" class="view on">
      <div class="card">
        <div class="row">
          <svg class="lg" viewBox="0 0 512 512"><use href="#m"/></svg>
          <div><h2 style="margin:0">Decide planes en grupo</h2><small class="pill">R√°pido y sin discusiones</small></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn p" onclick='tab("crear")'>Crear plan</button>
          <span class="pill">üîî Recordatorios</span><span class="pill">‚ú® Sugerencias</span>
        </div>
      </div>
      <div class="card" style="margin-top:12px"><h3>Lo mejor de la comunidad</h3><div id="homec" class="grid cards"></div></div>
    </section>

    <!-- CREAR (wizard en 4 fases) -->
    <section id="crear" class="view">
      <div class="card">
        <h2>Crear plan</h2>
        <div class="steps">
          <div class="step" data-s="1"><div class="dot">1</div><small class="pill">Detalles</small></div>
          <div class="step" data-s="2"><div class="dot">2</div><small class="pill">Invitados</small></div>
          <div class="step" data-s="3"><div class="dot">3</div><small class="pill">Actividades</small></div>
          <div class="step" data-s="4"><div class="dot">4</div><small class="pill">Compartir</small></div>
        </div>

        <!-- Paso 1: detalles -->
        <div id="s1" class="substep">
          <div class="row">
            <div class="col" style="flex:2"><label>T√≠tulo</label><input id="pt" class="input" value="Planazoo de hoy"></div>
            <div class="col" style="flex:1"><label>Fecha y hora</label><input id="pd" class="input" type="datetime-local"></div>
          </div>
          <div class="row" style="margin-top:6px">
            <div class="col" style="flex:1"><label>Ciudad</label><input id="pc" class="input" placeholder="Ciudad"></div>
            <div class="col" style="flex:1"><label>Tiempo para votar (min)</label><input id="pl" class="input" type="number" min="10" max="1440" value="120"></div>
          </div>
        </div>

        <!-- Paso 2: invitados -->
        <div id="s2" class="substep">
          <h3>Invitar amigos</h3>
          <div id="chips" class="row"></div>
          <div class="row">
            <input id="fnew" class="input" placeholder="A√±adir amigo (@usuario o nombre)">
            <button class="btn" onclick="addFriendInput()">A√±adir</button>
            <button class="btn" onclick="manageFriends()">Gestionar</button>
          </div>
        </div>

        <!-- Paso 3: actividades (sugerencias, favs, manual) -->
        <div id="s3" class="substep">
          <div class="row"><button class="btn s" onclick="openSug()" onclick="openMSug(); genSugUI()">Generar sugerencias</button><small class="pill">Seg√∫n preferencias</small></div>
          <div id="sugs" class="grid cards" style="margin-top:12px"></div>
          <h3 style="margin-top:14px">Opciones del plan</h3>
          <div id="opts" class="grid"></div>
          <h3 style="margin-top:14px">Tus favoritos</h3>
          <div id="favpick" class="grid cards"></div>
          <div class="row" style="margin-top:8px"><button class="btn" onclick="addManual()">+ Opci√≥n manual</button></div>
        </div>

        <!-- Paso 4: compartir -->
        <div id="s4" class="substep">
          <h3>Resumen</h3>
          <div id="sum" class="grid cards"></div>
          <div class="row" style="margin-top:10px">
            <button class="btn p" onclick="createShare()">Crear y compartir</button>
            <button class="btn" onclick="sharePreview()">Vista previa de enlace</button>
          </div>
        </div>

        <hr>
        <div class="row">
          <button id="pb" class="btn s" onclick="prevStep()">‚Üê Atr√°s</button>
          <div style="flex:1"></div>
          <button id="pn" class="btn s p" onclick="nextStep()">Continuar ‚Üí</button>
        </div>
      </div>
    </section>

    <section id="votar" class="view"><div class="card">
      <div class="row"><h2 id="vt">Vota</h2><span class="pill" id="collab">Colaborativo</span></div>
      <small>Se cierra en: <span id="rem">‚Äî</span></small>
      <div class="row" style="margin-top:12px"><input id="vn" class="input" placeholder="Tu nombre"></div>
      <hr>
      <div id="vlist" class="grid"></div>
      <div class="row" style="margin-top:8px"><button class="btn s" onclick="contrib()">+ A√±adir opci√≥n</button></div>
      <hr>
      <div class="row"><button class="btn p" onclick="goRes()">Ver resultados</button><button class="btn" onclick="share()">Compartir</button><small>Enlace: <span id="link" class="link"></span></small></div>
    </div></section>

    <section id="res" class="view"><div class="card">
      <div class="row"><h2 id="rt">Resultado</h2><span class="pill" id="state">‚Äî</span><div style="flex:1"></div><button class="btn" onclick="closeNow()">Cerrar</button></div><hr>
      <div id="rlist" class="grid"></div><hr><div id="win"></div>
      <div id="tie" style="display:none"><hr><h3>‚öñÔ∏è Desempate</h3><div class="row"><button class="btn" onclick="tRand()">Aleatorio</button><button class="btn" onclick="tManual()">Elegir manual</button></div><div id="tieopts" class="grid cards" style="margin-top:10px"></div></div>
      <hr><div class="row"><button class="btn" onclick="share()">Compartir</button><button class="btn" onclick="publish()">Publicar en comunidad</button></div>
    </div></section>

    <section id="hist" class="view"><div class="card"><h2>Historial</h2><div id="hlist" class="grid cards"></div></div></section>
    <section id="favs" class="view"><div class="card"><h2>Favoritos</h2><div class="row"><input id="fvi" class="input" placeholder="Ej. Restaurante X"><button class="btn p" onclick="addFav()">Guardar</button></div><div id="fv" class="grid cards" style="margin-top:12px"></div></div></section>
    <section id="comm" class="view"><div class="card"><h2>Comunidad</h2><div id="clist" class="grid cards"></div></div></section>

    <!-- Stats (acceso desde men√∫) -->
    <section id="stats" class="view"><div class="card"><h2>Estad√≠sticas</h2><div id="sw" class="grid"></div></div></section>

    <section id="prefs" class="view"><div class="card"><h2>Preferencias</h2>
      <div class="row">
        <div class="col" style="flex:1"><label>Ciudad</label><input id="pcity" class="input"></div>
        <div class="col" style="flex:1"><label>Presupuesto</label><select id="pbud"><option value="bajo">Bajo</option><option value="medio" selected>Medio</option><option value="alto">Alto</option></select></div>
      </div>
      <h3>Intereses</h3><div id="pints" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(160px,1fr))"></div>
      <div class="row" style="margin-top:12px"><button class="btn p" onclick="savePrefs()">Guardar</button><button class="btn" onclick='tab("home")'>Cancelar</button></div>
    </div></section>
  </div>

  <nav class="tabbar">
    <div class="tab on" data-t="home"><div>üè†</div><small>Inicio</small></div>
    <div class="tab" data-t="crear"><div>‚ûï</div><small>Crear</small></div>
    <div class="tab" data-t="hist"><div>üïò</div><small>Historial</small></div>
    <div class="tab" data-t="favs"><div>‚≠ê</div><small>Favoritos</small></div>
    <div class="tab" data-t="comm"><div>üåç</div><small>Comunidad</small></div>
  </nav>

  <!-- Modales -->
  <div class="modal" id="mf"><div class="sheet"><div class="row"><h3>Gestionar amigos</h3><div style="flex:1"></div><button class="btn s" onclick="closeMF()">Cerrar</button></div><div class="row" style="margin-top:6px"><input id="mfnew" class="input" placeholder="Nombre o @usuario"><button class="btn" onclick="addFriendModal()">A√±adir</button></div><div id="mfl" class="grid cards" style="margin-top:12px"></div></div></div>

  <div class="modal" id="mr"><div class="sheet"><div class="row"><h3>Valorar plan</h3><div style="flex:1"></div><button class="btn s" onclick="closeMR()">Cerrar</button></div><div class="row" id="rst"></div><div class="col" style="margin-top:6px"><label>Comentario</label><textarea id="rc" rows="3"></textarea></div><div class="row" style="margin-top:8px"><button class="btn p" onclick="saveRate()">Guardar valoraci√≥n</button></div></div></div>

  <div class="modal" id="msug">
    <div class="sheet">
      <div class="row">
        <h3>Sugerencias</h3>
        <div style="flex:1"></div>
        <button class="btn s" onclick="closeMSug()">Cerrar</button>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn s p" onclick="genSugUI()">‚Üª Generar m√°s</button>
        <button class="btn s" onclick="addManual()">+ A√±adir manual</button>
      </div>
      <div id="sugwrap" class="grid cards" style="margin-top:12px"></div>
      <small class="pill" style="margin-top:8px;display:inline-block">Puedes a√±adir varias sin cerrar este modal.</small>
    </div>
  </div>

  <div class="modal" id="ml"><div class="sheet">
    <div class="row"><h3>Iniciar sesi√≥n</h3><div style="flex:1"></div><button class="btn s" onclick="closeLogin()">Cerrar</button></div>
    <div class="row">
      <div class="col" style="flex:1"><label>Email</label><input id="le" class="input" type="email" placeholder="tucorreo@email.com"></div>
    </div>
    <div class="row" style="margin-top:8px"><button class="btn p" onclick="doLogin()">Entrar</button><button class="btn" onclick="demoLogin()">Demo</button></div>
  </div></div>

</div>

<!-- ====== JS de la app ====== -->
<script>
/* ====== Constantes y utilidades ====== */
const K={POLLS:'pz_polls',PREFS:'pz_prefs',FAVS:'pz_favs',STATS:'pz_stats',FRI:'pz_friends_v2',COMM:'pz_comm',RATE:'pz_ratings',USER:'pz_user'}
const CATS=[{id:'gastronomia',l:'üçΩ Gastronom√≠a'},{id:'musica',l:'üéµ M√∫sica'},{id:'cine',l:'üé¨ Cine/Series'},{id:'deporte',l:'‚öΩ Deporte'},{id:'naturaleza',l:'üåø Naturaleza'},{id:'cultura',l:'üé® Cultura/Arte'},{id:'juegos',l:'üéÆ Juegos/Ocio'}]
const S=[{t:'Cata de vinos',cat:'gastronomia',p:15,tod:'tarde',pl:'Bodega'},{t:'Tapeo casco',cat:'gastronomia',p:12,tod:'noche',pl:'Ruta gastro'},{t:'Concierto plaza',cat:'musica',p:0,tod:'noche',pl:'Plaza Mayor'},{t:'Jam en bar',cat:'musica',p:8,tod:'noche',pl:'Bar indie'},{t:'Estreno cine',cat:'cine',p:7,tod:'noche',pl:'Cines'},{t:'Series + pizza',cat:'cine',p:10,tod:'tarde',pl:'En casa'},{t:'F√∫tbol sala',cat:'deporte',p:5,tod:'tarde',pl:'Pabell√≥n'},{t:'Bici r√≠o',cat:'naturaleza',p:0,tod:'ma√±ana',pl:'Parque'},{t:'Miradores',cat:'naturaleza',p:0,tod:'tarde',pl:'Mirador'},{t:'Expo arte',cat:'cultura',p:6,tod:'tarde',pl:'Museo'},{t:'Teatro alt',cat:'cultura',p:18,tod:'noche',pl:'Sala'},{t:'Escape room',cat:'juegos',p:20,tod:'tarde',pl:'Escape'},{t:'Juegos mesa',cat:'juegos',p:5,tod:'noche',pl:'Caf√© juegos'}]
const COMM_DEF=[{id:'c1',title:'Tacos + karaoke',desc:'Cena y karaoke',rating:42,cat:'gastronomia'},{id:'c2',title:'Picnic atardecer',desc:'Parque y m√∫sica',rating:35,cat:'naturaleza'},{id:'c3',title:'Cine al aire libre',desc:'Plaza + helados',rating:28,cat:'cine'}]
const U=(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch(e){return d}}, SVE=(k,v)=>localStorage.setItem(k,JSON.stringify(v))
const q=s=>document.querySelector(s), qq=s=>Array.from(document.querySelectorAll(s)), uid=()=>Math.random().toString(36).slice(2,10), now=()=>Date.now(), fmt=ts=>new Date(ts).toLocaleString(), toLocal=ts=>new Date(ts-new Date().getTimezoneOffset()*60000).toISOString().slice(0,16)
const icon=c=>({gastronomia:'üçΩ',musica:'üéµ',cine:'üé¨',deporte:'‚öΩ',naturaleza:'üåø',cultura:'üé®',juegos:'üéÆ'}[c]||'‚ú®')

/* ====== Tema ====== */
document.getElementById('th').onclick=()=>{document.documentElement.classList.toggle('dark');SVE('pz_theme',document.documentElement.classList.contains('dark')?'dark':'light')}
;(function(){const s=U('pz_theme',null)||(matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'); if(s==='dark') document.documentElement.classList.add('dark')})()

/* ====== Cuenta / Login (UI local) ====== */
function openMenu(){q('#amenu').classList.add('open')} function closeMenu(){q('#amenu').classList.remove('open')}
q('#abtn').addEventListener('click',()=>{q('#amenu').classList.toggle('open')});
document.addEventListener('click',e=>{if(!q('#amenu').contains(e.target) && !q('#abtn').contains(e.target)) closeMenu()})
function user(){return U(K.USER,null)} function setUser(u){SVE(K.USER,u); hydrateAccount()}
function hydrateAccount(){const u=user(); q('#aico').textContent=u? (u.name?.[0]||'?').toUpperCase() : '?'; q('#aname').textContent=u? u.name : 'Invitado'; q('#amenu').querySelector('a').textContent=u? 'üë§ Mi cuenta' : 'üë§ Iniciar sesi√≥n'}
function openLogin(){q('#ml').style.display='flex'} function closeLogin(){q('#ml').style.display='none'}
function demoLogin(){setUser({name:'Demo',email:'demo@planazoo.app'}); closeLogin()}
function logout(){localStorage.removeItem(K.USER); hydrateAccount(); closeMenu(); alert('Sesi√≥n cerrada')}
hydrateAccount();

/* ====== NAV ====== */
function tab(name){ qq('.tab').forEach(t=>t.classList.toggle('on',t.dataset.t===name)); qq('.view').forEach(v=>v.classList.remove('on')); q('#'+name).classList.add('on')
  if(name==='crear') renderCrear(); if(name==='hist') renderHist(); if(name==='favs') renderFavs(); if(name==='stats') renderStats(); if(name==='comm') renderComm(); if(name==='home'){renderHomeC()}
}
qq('.tab').forEach(t=>t.onclick=()=>tab(t.dataset.t))

/* ====== PREFS ====== */
function openPrefs(){ tab('prefs'); const p=U(K.PREFS,{city:'',budget:'medio',ints:[]}); q('#pcity').value=p.city||''; q('#pbud').value=p.budget||'medio'; const wrap=q('#pints'); wrap.innerHTML=''; CATS.forEach(c=>{const l=document.createElement('label'); l.className='pill'; l.innerHTML=`<input type='checkbox' value='${c.id}'> ${c.l}`; wrap.appendChild(l)}); const set=new Set(p.ints||[]); wrap.querySelectorAll('input').forEach(i=>i.checked=set.has(i.value)) }
function savePrefs(){ const city=q('#pcity').value.trim(),budget=q('#pbud').value,ints=[...q('#pints').querySelectorAll('input:checked')].map(i=>i.value); SVE(K.PREFS,{city, budget, ints}); alert('Preferencias guardadas'); tab('crear') }

/* ====== Amigos ====== */
function defaultFriends(){return [
  {id:'u1',name:'Ver√≥nica',handle:'@vero',avatar:'V'},
  {id:'u2',name:'Marcos',handle:'@marcos',avatar:'M'},
  {id:'u3',name:'Luc√≠a',handle:'@luci',avatar:'L'}
]}
function friends(){const raw=U(K.FRI,null); if(!raw){SVE(K.FRI,defaultFriends()); return defaultFriends()} return raw.map(x=>typeof x==='string'? {id:uid(),name:x,handle:'@'+x.toLowerCase().replace(/\s+/g,''),avatar:(x[0]||'?').toUpperCase()} : x)}
function saveFriends(a){SVE(K.FRI,a)}
function renderChips(sel=new Set()){ const w=q('#chips'); w.innerHTML=''; friends().forEach(u=>{const s=document.createElement('span'); s.className='chip'; s.style.cursor='pointer'; s.innerHTML=`<span class='avatar' style='width:22px;height:22px;font-size:12px'>${u.avatar}</span> ${u.name}`; if(sel.has(u.id)) s.style.background='color-mix(in oklab,var(--b) 18%, var(--chip))'; s.onclick=()=>{sel.has(u.id)?sel.delete(u.id):sel.add(u.id); renderChips(sel)}; w.appendChild(s)}); w.dataset.sel=JSON.stringify([...sel]) }
function addFriendInput(){ const v=q('#fnew').value.trim(); if(!v) return; const u={id:uid(),name:v.replace(/^@/,''),handle:v.startsWith('@')?v:'@'+v.toLowerCase().replace(/\s+/g,''),avatar:(v.replace(/^@/,'')[0]||'?').toUpperCase()}; saveFriends([...friends(),u]); q('#fnew').value=''; renderChips(new Set(JSON.parse(q('#chips').dataset.sel||'[]'))); renderMF() }
function manageFriends(){ q('#mf').style.display='flex'; renderMF() } function closeMF(){ q('#mf').style.display='none' }
function renderMF(){ const w=q('#mfl'); w.innerHTML=''; friends().forEach(u=>{const d=document.createElement('div'); d.className='opt'; d.innerHTML=`<div class='row'><div style='display:flex;align-items:center;gap:8px'><span class='avatar'>${u.avatar}</span><div><b>${u.name}</b><br><small class='pill'>${u.handle}</small></div></div><div style='flex:1'></div><button class='btn s'>Eliminar</button></div>`; d.querySelector('button').onclick=()=>{ saveFriends(friends().filter(x=>x.id!==u.id)); renderMF(); renderChips(new Set()) }; w.appendChild(d) }) }
function addFriendModal(){ const v=q('#mfnew').value.trim(); if(!v) return; const u={id:uid(),name:v.replace(/^@/,''),handle:v.startsWith('@')?v:'@'+v.toLowerCase().replace(/\s+/g,''),avatar:(v.replace(/^@/,'')[0]||'?').toUpperCase()}; saveFriends([...friends(),u]); q('#mfnew').value=''; renderMF(); renderChips(new Set()) }

/* ====== Crear (wizard) ====== */
let step=1, opts=[]
function setStep(n){ step=n; qq('.step').forEach(s=>{const i=parseInt(s.dataset.s,10); s.classList.toggle('on',i===step); s.classList.toggle('done',i<step)}); qq('.substep').forEach(x=>x.classList.remove('on')); q('#s'+step).classList.add('on'); q('#pb').disabled=step===1; q('#pn').textContent=step===4?'Finalizar':'Continuar ‚Üí'; if(step===4) renderSummary() }
function prevStep(){ if(step>1){ setStep(step-1) } }
function nextStep(){ if(step===1){ if(!guardDetails()) return; if(!user()) { openLogin(); return } setStep(2) } else if(step===2){ setStep(3) } else if(step===3){ if(opts.length<1){ alert('A√±ade al menos 1 actividad'); return } setStep(4) } else if(step===4){ createShare() } }
function guardDetails(){ const title=q('#pt').value.trim(), dt=q('#pd').value; if(!title||!dt){ alert('Completa t√≠tulo y fecha/hora'); return false } return true }
function renderSummary(){ const sum=q('#sum'); sum.innerHTML=''; const invited=JSON.parse(q('#chips').dataset.sel||'[]').map(id=>friends().find(f=>f.id===id)); const card1=document.createElement('div'); card1.className='opt'; card1.innerHTML=`<b>üìõ ${q('#pt').value.trim()}</b><br><small class='pill'>${q('#pd').value}</small><br><small class='pill'>${invited.length} invitado(s)</small>`; sum.appendChild(card1); const card2=document.createElement('div'); card2.className='opt'; if(!opts.length){card2.innerHTML='<small class="pill">Sin actividades</small>'} else {card2.innerHTML='<b>üóÇ Actividades</b>'; const ul=document.createElement('ul'); ul.style.marginTop='6px'; opts.forEach(o=>{const li=document.createElement('li'); li.textContent=o.t; ul.appendChild(li)}); card2.appendChild(ul)} sum.appendChild(card2) }
function sharePreview(){ alert('El enlace se generar√° al crear el plan. Se compartir√° por WhatsApp o compartir nativo.') }

function renderCrear(){ const p=U(K.PREFS,{city:'',budget:'medio',ints:[]}); q('#pc').value=p.city||''; const d=new Date(Date.now()+2*3600*1000); d.setMinutes(0,0,0); q('#pd').value=toLocal(d.getTime()); opts=[]; ropts(); q('#sugs').innerHTML=''; rfavpick(); renderChips(new Set()); setStep(1) }
function ropts(){ const w=q('#opts'); w.innerHTML=''; if(!opts.length){ w.innerHTML='<small class=pill>No hay actividades a√∫n</small>'; return } opts.forEach((o,i)=>{ const r=document.createElement('div'); r.className='opt'; r.innerHTML=`<div class='row'><div style='flex:1'>${o.t}</div><button class='btn s'>Eliminar</button></div>`; r.querySelector('button').onclick=()=>{opts.splice(i,1);ropts()}; w.appendChild(r) }) }
function genSugUI(){ const p=U(K.PREFS,{budget:'medio',ints:[]}), max=p.budget==='bajo'?10:(p.budget==='medio'?30:999), ints=new Set((p.ints||[]).length?p.ints:CATS.map(c=>c.id)); const tod=(d=>{const h=d.getHours();return h<12?'ma√±ana':(h<20?'tarde':'noche')})(new Date(q('#pd').value||Date.now()+2*3600*1000)); const list=S.filter(s=>ints.has(s.cat)&&s.p<=max&&(s.tod===tod||Math.random()<.35)).sort(()=>Math.random()-.5).slice(0,5); const w=q('#sugs'); w.innerHTML=''; list.forEach(s=>{ const d=document.createElement('div'); d.className='opt'; d.innerHTML=`<b>${icon(s.cat)} ${s.t}</b><br><small class='pill'>~ ${s.p}‚Ç¨ ¬∑ ${s.tod}</small><div class='row' style='margin-top:6px'><button class='btn s p'>A√±adir</button><button class='btn s'>Fav</button></div>`; d.querySelectorAll('button')[0].onclick=()=>{opts.push({t:`${s.t} ‚Äî ${s.pl} (~${s.p}‚Ç¨)`,cat:s.cat}); ropts()}; d.querySelectorAll('button')[1].onclick=()=>addFavText(`${s.t} ‚Äî ${s.pl}`); w.appendChild(d) }) }
function addManual(){ const t=prompt('Escribe la actividad/plan'); if(!t) return; opts.push({t}); ropts() }
function ol(){return parseInt(localStorage.getItem('pz_limit_options')||'5',10)} function al(){return parseInt(localStorage.getItem('pz_limit_active')||'3',10)}
function createShare(){ if(!guardDetails()) return; const title=q('#pt').value.trim(), dl=Math.max(10,Math.min(1440,parseInt(q('#pl').value||'120',10))), dt=q('#pd').value?new Date(q('#pd').value).getTime():Date.now()+2*3600*1000; if(opts.length<1){alert('A√±ade al menos 1 actividad');return} const polls=U(K.POLLS,{}); const active=Object.values(polls).filter(p=>!p.closed&&p.when>now()).length; if(active>=al()){alert('L√≠mite de planes activos (freemium)');return} const id=uid(), invited=(JSON.parse(q('#chips').dataset.sel||'[]')); polls[id]={id,title,options:opts.map((o,i)=>({id:i,text:o.t,votes:0,meta:o.cat?{cat:o.cat}:null})),createdAt:now(),deadline:now()+dl*60000,when:dt,closed:false,collab:true,invited,owner:user()?.email||'demo',rating:0,cancelled:false}; SVE(K.POLLS,polls); location.hash='#/votar/'+id; renderVote(); qq('.view').forEach(v=>v.classList.remove('on')); q('#votar').classList.add('on') }

/* ====== Votar / Resultado ====== */
let tmr=null, tie=[];
function renderVote(){ const id=location.hash.split('/')[2], polls=U(K.POLLS,{}), p=polls[id]; if(!p){alert('No existe'); tab('home'); return}
  q('#vt').textContent='Vota: '+p.title; q('#collab').style.display=p.collab?'inline-block':'none'; q('#vn').value=localStorage.getItem('pz_nombre')||''; q('#link').textContent=location.origin+location.pathname+'#/votar/'+id;
  const w=q('#vlist'); w.innerHTML=''; const closed=p.closed||now()>=p.deadline;
  p.options.forEach(o=>{const d=document.createElement('div'); d.className='opt'; d.innerHTML=`<div class='row'><div style='flex:1'>${o.text}</div><button class='btn s p'>Votar</button></div>`; const b=d.querySelector('button'); b.disabled=closed; b.onclick=()=>{const n=q('#vn').value.trim(); if(!n){alert('Pon tu nombre');return} localStorage.setItem('pz_nombre',n); o.votes=(o.votes||0)+1; const polls=U(K.POLLS,{}); polls[id]=p; SVE(K.POLLS,polls); location.hash='#/res/'+id; renderRes(); qq('.view').forEach(v=>v.classList.remove('on')); q('#res').classList.add('on')}; w.appendChild(d)});
  clearInterval(tmr); tmr=setInterval(()=>{const r=Math.max(0,p.deadline-now()); q('#rem').textContent=(p.closed?'Cerrada':Math.floor(r/60000)+'m '+Math.floor((r%60000)/1000)+'s')},500)
}
function contrib(){ const id=location.hash.split('/')[2], polls=U(K.POLLS,{}), p=polls[id]; if(!p||p.closed||now()>=p.deadline){alert('Cerrada');return} const t=prompt('A√±ade tu opci√≥n'); if(!t) return; p.options.push({id:p.options.length,text:t,votes:0}); polls[id]=p; SVE(K.POLLS,polls); renderVote() }
function goRes(){ renderRes(); qq('.view').forEach(v=>v.classList.remove('on')); q('#res').classList.add('on') }
function renderRes(){ const id=location.hash.split('/')[2], polls=U(K.POLLS,{}), p=polls[id]; if(!p){alert('No existe'); tab('home'); return}
  q('#rt').textContent='Resultado: '+p.title; q('#state').textContent=(p.closed||now()>=p.deadline)?'Cerrada':'Abierta';
  const w=q('#rlist'); w.innerHTML=''; let sum=0,max=-1,win=null; p.options.forEach(o=>{sum+=(o.votes||0); if((o.votes||0)>max){max=o.votes||0;win=o}});
  p.options.forEach(o=>{const d=document.createElement('div'); d.className='opt'; d.innerHTML=`<div class='row' style='justify-content:space-between'><div>${o.text}</div><b>${o.votes||0}</b></div>`; w.appendChild(d)});
  const leaders=p.options.filter(o=>(o.votes||0)===max);
  if(leaders.length>1 && (p.closed||now()>=p.deadline)){ q('#tie').style.display='block'; const tw=q('#tieopts'); tw.innerHTML=''; leaders.forEach(o=>{ const d=document.createElement('div'); d.className='opt'; d.textContent=o.text; tw.appendChild(d)}); tie=leaders.map(o=>o.id); q('#win').innerHTML='<small class=pill>Empate detectado</small>' } else { q('#tie').style.display='none'; q('#win').innerHTML=win?`<h3>üéâ Ganador: ${win.text}</h3><small class='pill'>Total votos: ${sum}</small>`:'<small class=pill>A√∫n no hay votos</small>' }
}
function closeNow(){ const id=location.hash.split('/')[2], polls=U(K.POLLS,{}), p=polls[id]; if(!p) return; p.closed=true; polls[id]=p; SVE(K.POLLS,polls); renderRes() }
function tRand(){ const id=location.hash.split('/')[2], polls=U(K.POLLS,{}), p=polls[id]; if(!p||!tie.length) return; const chosen=tie[Math.floor(Math.random()*tie.length)]; const opt=p.options.find(o=>o.id===chosen); q('#tie').style.display='none'; q('#win').innerHTML=`<h3>üéâ Ganador (aleatorio): ${opt.text}</h3>` }
function tManual(){ const id=location.hash.split('/')[2], polls=U(K.POLLS,{}), p=polls[id]; const names=p.options.filter(o=>tie.includes(o.id)).map(o=>o.text).join(' | '); const pick=prompt('Elige una: '+names); const opt=p.options.find(o=>o.text===pick); if(opt){ q('#tie').style.display='none'; q('#win').innerHTML=`<h3>üéâ Ganador (manual): ${opt.text}</h3>` } }
function share(){ const url=location.href, txt='√önete a decidir el plan en Planazoo'; if(navigator.share){navigator.share({title:'Planazoo',text:txt,url}).catch(()=>{})} else {navigator.clipboard.writeText(url); alert('Enlace copiado')} window.open('https://wa.me/?text='+encodeURIComponent(txt+' '+url),'_blank') }
function publish(){ const id=location.hash.split('/')[2], polls=U(K.POLLS,{}), p=polls[id]; if(!p){alert('No encontrado');return} const c=U(K.COMM,COMM_DEF); c.push({id:'u'+id,title:p.title,desc:(p.options[0]?.text||'Plan'),rating:10,cat:(p.options[0]?.meta?.cat||'cultura')}); SVE(K.COMM,c); alert('Publicado en comunidad'); renderComm(); renderHomeC() }
function publishPlan(id){ const polls=U(K.POLLS,{}), p=polls[id]; if(!p){alert('No encontrado');return} const c=U(K.COMM,COMM_DEF); c.push({id:'u'+id,title:p.title,desc:(p.options[0]?.text||'Plan'),rating:10,cat:(p.options[0]?.meta?.cat||'cultura')}); SVE(K.COMM,c); alert('Publicado en comunidad'); renderComm(); renderHomeC(); }

/* ====== Historial / rating ====== */
let rateId=null, stars=0
function renderHist(){ const polls=U(K.POLLS,{}), ratings=U(K.RATE,{}), w=q('#hlist'); w.innerHTML=''; const arr=Object.values(polls).sort((a,b)=>b.when-a.when); if(!arr.length){ w.innerHTML='<div class=pill>No hay planes</div>'; return } arr.forEach(p=>{ const st=p.cancelled?'Cancelado':(p.closed?'Cerrado':(now()>=p.deadline?'Cerrando':'Activo')); const rated=ratings[p.id]?.stars; const d=document.createElement('div'); d.className='opt'; d.innerHTML=`<div class='row' style='justify-content:space-between;align-items:flex-start'><div><b>${p.title}</b><br><small class='pill'>${fmt(p.when)} ¬∑ ${st}</small>${rated?`<br><small>‚òÖ ${rated}/5</small>`:''}</div><div class='row'><button class='btn s' onclick='openVote("${p.id}")'>Abrir</button><button class='btn s' onclick='cancelPlan("${p.id}")'>Cancelar</button><button class='btn s' onclick='delPlan("${p.id}")'>Borrar</button>${(p.closed||p.cancelled||p.when<now())?`<button class='btn s' onclick='openMR("${p.id}")'>Valorar</button>`:''}</div></div>`; w.appendChild(d) }) }
function openVote(id){ location.hash='#/votar/'+id; qq('.view').forEach(v=>v.classList.remove('on')); q('#votar').classList.add('on'); renderVote() }
function delPlan(id){ if(!confirm('¬øSeguro?')) return; const polls=U(K.POLLS,{}); delete polls[id]; SVE(K.POLLS,polls); renderHist() }
function cancelPlan(id){ const polls=U(K.POLLS,{}), p=polls[id]; if(!p) return; p.cancelled=true; p.closed=true; polls[id]=p; SVE(K.POLLS,polls); renderHist() }
function openMR(id){ rateId=id; stars=0; rst(); q('#rc').value=''; q('#mr').style.display='flex' } function closeMR(){ q('#mr').style.display='none'; rateId=null }
function rst(){ const w=q('#rst'); w.innerHTML=''; for(let i=1;i<=5;i++){ const s=document.createElement('span'); s.className='star'+(i<=stars?' on':''); s.textContent='‚òÖ'; s.onclick=()=>{stars=i; rst()}; w.appendChild(s) } }
function saveRate(){ if(stars<1){alert('Selecciona estrellas');return} const r=U(K.RATE,{}); r[rateId]={stars,comment:q('#rc').value.trim(),at:now()}; SVE(K.RATE,r); closeMR(); alert('¬°Gracias!'); renderHist() }

/* ====== Favoritos ====== */
function gFav(){return U(K.FAVS,[])} function sFav(a){SVE(K.FAVS,a)} function addFav(){ const v=q('#fvi').value.trim(); if(!v) return; if(gFav().includes(v)){alert('Ya existe');return} sFav([...gFav(),v]); q('#fvi').value=''; renderFavs(); rfavpick() }
function addFavText(t){ if(gFav().includes(t)) return; sFav([...gFav(),t]); renderFavs(); rfavpick() }
function renderFavs(){ const w=q('#fv'); w.innerHTML=''; const a=gFav(); if(!a.length){ w.innerHTML='<div class=pill>Sin favoritos</div>'; return } a.forEach(t=>{ const d=document.createElement('div'); d.className='opt'; d.innerHTML=`<div class='row'><div style='flex:1'>${t}</div><button class='btn s p'>A√±adir al plan</button><button class='btn s'>Eliminar</button></div>`; d.querySelectorAll('button')[0].onclick=()=>{opts.push({t}); ropts()}; d.querySelectorAll('button')[1].onclick=()=>{ sFav(gFav().filter(x=>x!==t)); renderFavs(); rfavpick() }; w.appendChild(d) }) }
function rfavpick(){ const w=q('#favpick'); w.innerHTML=''; const a=gFav(); if(!a.length){ w.innerHTML='<div class=pill>Sin favoritos</div>'; return } a.forEach(t=>{ const d=document.createElement('div'); d.className='opt'; d.innerHTML=`<div class='row'><div style='flex:1'>${t}</div><button class='btn s p'>A√±adir</button></div>`; d.querySelector('button').onclick=()=>{opts.push({t}); ropts()}; w.appendChild(d) }) }

/* ====== Comunidad / Home ====== */
function gComm(){return U(K.COMM,COMM_DEF)} function sComm(a){SVE(K.COMM,a)}
function renderComm(){ const w=q('#clist'); w.innerHTML=''; gComm().sort((a,b)=>b.rating-a.rating).forEach(i=>{ const d=document.createElement('div'); d.className='opt'; d.innerHTML=`<b>${icon(i.cat)} ${i.title}</b><br><small class='pill'>‚òÖ ${i.rating}</small><div class='row' style='margin-top:6px'><button class='btn s'>Me gusta</button><button class='btn s p'>A√±adir a mi plan</button><button class='btn s'>Fav</button></div>`; const bs=d.querySelectorAll('button'); bs[0].onclick=()=>{ const c=gComm(); c.find(x=>x.id===i.id).rating++; sComm(c); renderComm(); renderHomeC() }; bs[1].onclick=()=>{ opts.push({t:i.title+' ‚Äî '+i.desc,cat:i.cat}); ropts() }; bs[2].onclick=()=>addFavText(i.title+' ‚Äî '+i.desc); w.appendChild(d) }) }
function renderHomeC(){ const w=q('#homec'); w.innerHTML=''; gComm().sort((a,b)=>b.rating-a.rating).slice(0,3).forEach(i=>{ const d=document.createElement('div'); d.className='opt'; d.innerHTML=`<div class='row' style='justify-content:space-between'><div><b>${i.title}</b><br><small class='pill'>${i.desc||''}</small></div><span class='pill'>‚òÖ ${i.rating}</span></div>`; w.appendChild(d) }) }

/* ====== Stats ====== */
function renderStats(){ const st=U(K.STATS,{cats:{},tod:{},count:0}), w=q('#sw'); w.innerHTML=''; const favCat=Object.entries(st.cats).sort((a,b)=>b[1]-a[1])[0]?.[0]||'‚Äî', favTod=Object.entries(st.tod).sort((a,b)=>b[1]-a[1])[0]?.[0]||'‚Äî'; [['Categor√≠a top',favCat],['Franja favorita',favTod],['Votos totales',st.count]].forEach(([k,v])=>{ const d=document.createElement('div'); d.className='opt'; d.innerHTML=`<div class='row' style='justify-content:space-between'><div>${k}</div><b>${v}</b></div>`; w.appendChild(d) }) }
function track(o){ const st=U(K.STATS,{cats:{},tod:{},count:0}); const cat=(o.meta&&o.meta.cat)||'otros'; st.cats[cat]=(st.cats[cat]||0)+1; st.tod['tarde']=(st.tod['tarde']||0)+1; st.count++; SVE(K.STATS,st) }

/* === Modal de sugerencias: mover #sugs dentro del modal y devolverlo al cerrar === */
let _sugs_parent=null, _sugs_next=null;
function _ensureSugAnchors(){
  const node=document.getElementById('sugs');
  if(node && !_sugs_parent){
    _sugs_parent=node.parentElement;
    _sugs_next=node.nextSibling;
  }
}
function openSug(){
  _ensureSugAnchors();
  const node=document.getElementById('sugs');
  const wrap=document.getElementById('sugwrap');
  if(!node || !wrap) return;
  wrap.innerHTML='';
  wrap.appendChild(node);
  genSugUI();
  document.getElementById('msug').style.display='flex';
}
function closeMSug(){
  const node=document.getElementById('sugs');
  if(node && _sugs_parent){
    if(_sugs_next){ _sugs_parent.insertBefore(node,_sugs_next); }
    else { _sugs_parent.appendChild(node); }
  }
  document.getElementById('msug').style.display='none';
}
document.addEventListener('click',e=>{
  const m=document.getElementById('msug');
  if(m && m.style.display==='flex' && e.target===m){ closeMSug() }
});
</script>

<!-- ====== Supabase (a√±adido) ====== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ‚¨áÔ∏è Sustituye por tus valores reales (Supabase ‚Üí Settings ‚Üí API)
  window.SUPABASE_URL = "https://ggxdzwjlkqqznpzrfayl.supabase.co";
  window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdneGR6d2psa3Fxem5wenJmYXlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MTY4NDksImV4cCI6MjA3MDQ5Mjg0OX0.wHb_QV4t_MHSQNyBXrU3k-MTUWXn4fwhwNOw4YscyWc";
  const SB = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

  // Listener de sesi√≥n: al volver del magic link sincroniza la UI
  SB.auth.onAuthStateChange(async (_event, session) => {
    if (session?.user) {
      setUser({
        name: session.user.email?.split('@')[0] || 'Usuario',
        email: session.user.email || ''
      });
      try {
        await SB.from('users').upsert({
          id: session.user.id,
          email: session.user.email,
          name: session.user.user_metadata?.name || null
        });
      } catch(_) {}
      closeLogin();
      alert('Sesi√≥n iniciada');
    }
  });

  // Reemplazo de doLogin() para magic link
  async function doLogin(){
    const e = document.querySelector('#le').value.trim();
    if(!e){ alert('Escribe tu email'); return; }
    try{
      await SB.auth.signInWithOtp({ email: e });
      alert('Te envi√© un enlace de acceso. Abre tu correo y confirma.');
    }catch(err){
      alert('Error enviando enlace: ' + (err?.message || err));
    }
  }
</script>

<!-- (si tienes service worker, lo registrar√° tu script/manifest) -->
</body>
</html>
